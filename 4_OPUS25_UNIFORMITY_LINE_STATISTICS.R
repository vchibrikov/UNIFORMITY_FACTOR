# -----------------------------------------------------------------------------
#
# Script: Line Uniformity and Width Analysis
# Author: Vadym Chibrikov
# Date: 2025-10-07
#
# Description: This script analyzes 3D printed line data from Excel files
#              generated by a preceding Python image analysis tool. It calculates
#              three key metrics: Uniformity Factor, Line Width (mm), and Line
#              Length (mm). It then generates and saves publication-quality
#              plots for each metric.
#
# -----------------------------------------------------------------------------


# -----------------------------------------------------------------------------
# SECTION 1: SETUP AND CONFIGURATION
# -----------------------------------------------------------------------------

# --- 1.1: Load Required Libraries ---
# Using pacman to install and load packages in one step
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  'tidyverse', 'readxl', 'writexl', 'RColorBrewer', 'bbplot', 'Cairo', 'agricolae'
)

# --- 1.2: Configuration ---
# Define file paths, output directories, and key analysis parameters here.

# Input files
raw_data_path  <- "./raw/data/path.xlsx"
scale_data_path <- "./scale/data/path.xlsx"

# Output directory for plots
output_dir <- "./path/for/output/directory/"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

# Analysis parameters
FILTER_COMPOSITION <- "YOUR_FILTER" # Which composition number to analyze
LOGICAL_ORDER <- c("YOUR", "ORDER") # The order of samples on the x-axis of the plot

# --- 1.3: Plotting Parameters ---
# Global settings for ggplot aesthetics
colors <- brewer.pal(9, "Set1")
axis.text.font.size <- 16
axis.title.font.size <- 18
width_index <- 0.2


# -----------------------------------------------------------------------------
# SECTION 2: DATA LOADING AND PREPARATION
# -----------------------------------------------------------------------------
# This section loads the raw data and the scale data, parses filenames to
# extract experimental parameters, and joins them into a single, clean tibble.
# This is done only ONCE to avoid repetition.

# --- 2.1: Load Raw Width Data ---
raw_data <- read_excel(raw_data_path) %>%
  # Remove the .png extension from filenames for easier matching
  mutate(filename_base = str_remove(filename, "\\.png$")) %>%
  # The pattern assumes a filename structure like:
  # DATE_DATE_DATE_COMP_NR_PRESSURE_SPEED_SEGMENT
  tidyr::extract(
    filename_base,
    into = c("date", "composition_nr", "pressure_kpa", "speed_mm_min", "segment"),
    regex = "(\\d{4}_\\d{2}_\\d{2})_(G\\d_\\d)_(\\d+)_(\\d+)_(.*)",
    remove = FALSE
  ) %>%
  # Create a grouping variable for each experimental condition
  mutate(
    file_group = paste(composition_nr, pressure_kpa, speed_mm_min, sep = "_")
  )

# --- 2.2: Load Scale Data ---
scale_data <- read_excel(scale_data_path) %>%
  mutate(
    filename = str_remove(filename, "\\.png$"),
    date = str_extract(filename, "\\d{4}_\\d{2}_\\d{2}")
  ) %>%
  select(date, distance_10_mm_px)

# --- 2.3: Join Data and Perform Initial Calculations ---
full_data <- raw_data %>%
  left_join(scale_data, by = "date") %>%
  # Ensure columns are numeric
  mutate(
    perpendicular_length_px = as.numeric(perpendicular_length_px),
    distance_10_mm_px = as.numeric(distance_10_mm_px)
  ) %>%
  # Convert pixel measurements to millimeters
  mutate(
    perpendicular_length_mm = perpendicular_length_px / (distance_10_mm_px / 10)
  ) %>%
  # Remove rows with missing data that would cause errors
  filter(!is.na(perpendicular_length_px), !is.na(distance_10_mm_px))


# -----------------------------------------------------------------------------
# SECTION 3: UNIFORMITY FACTOR ANALYSIS
# -----------------------------------------------------------------------------

# --- 3.1: Calculate Uniformity Factor ---
# The uniformity factor is defined as 1 - (SD / Mean)
uniformity_data <- full_data %>%
  group_by(filename_base, file_group) %>%
  summarise(
    mean_px = mean(perpendicular_length_px, na.rm = TRUE),
    sd_px = sd(perpendicular_length_px, na.rm = TRUE),
    uniformity_factor = 1 - (sd_px / mean_px),
    .groups = 'drop'
  ) %>%
  # Filter for the specific composition defined in the config
  filter(str_detect(file_group, FILTER_COMPOSITION)) %>%
  # Aggregate results for each experimental group
  group_by(file_group) %>%
  summarise(
    mean_uniformity_factor = mean(uniformity_factor, na.rm = TRUE),
    sd_uniformity_factor = sd(uniformity_factor, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # Set the desired order for plotting
  mutate(file_group = factor(file_group, levels = LOGICAL_ORDER))

# --- 3.2: Plot Uniformity Factor ---
uniformity_plot <- ggplot(data = uniformity_data, aes(x = file_group, y = mean_uniformity_factor, color = file_group)) +
  geom_bar(stat = "identity", fill = NA, linewidth = 1) +
  geom_errorbar(
    aes(
      ymin = mean_uniformity_factor - sd_uniformity_factor,
      ymax = mean_uniformity_factor + sd_uniformity_factor
    ),
    width = width_index,
    linewidth = 1
  ) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "#333333") +
  scale_y_continuous(limits = c(0, 1.25), breaks = seq(0, 1.25, 0.25)) +
  scale_color_manual(values = colors) +
  labs(x = "Sample", y = "Uniformity factor (a.u.)") +
  bbc_style() +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.title = element_text(size = axis.title.font.size, face = "bold"),
    axis.text = element_text(size = axis.text.font.size)
  )

# --- 3.3: Save the Plot ---
ggsave(
  filename = file.path(output_dir, "UNIFORMITY_FACTOR.jpeg"),
  plot = uniformity_plot,
  width = 12, height = 12, units = "cm",
  dpi = 600, device = "cairo_jpeg"
)


# -----------------------------------------------------------------------------
# SECTION 4: LINE WIDTH ANALYSIS (mm)
# -----------------------------------------------------------------------------

# --- 4.1: Calculate Average Line Width ---
width_data <- full_data %>%
  filter(str_detect(file_group, FILTER_COMPOSITION)) %>%
  group_by(file_group) %>%
  summarise(
    mean_width_mm = mean(perpendicular_length_mm, na.rm = TRUE),
    sd_width_mm = sd(perpendicular_length_mm, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(file_group = factor(file_group, levels = LOGICAL_ORDER))

# --- 4.2: Plot Line Width ---
width_plot <- ggplot(data = width_data, aes(x = file_group, y = mean_width_mm, color = file_group)) +
  geom_bar(stat = "identity", fill = NA, linewidth = 1) +
  geom_errorbar(
    aes(
      ymin = mean_width_mm - sd_width_mm,
      ymax = mean_width_mm + sd_width_mm
    ),
    width = width_index,
    linewidth = 1
  ) +
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, 1)) +
  scale_color_manual(values = colors) +
  labs(x = "Sample", y = "Line width (mm)") +
  bbc_style() +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.title = element_text(size = axis.title.font.size, face = "bold"),
    axis.text = element_text(size = axis.text.font.size)
  )

# --- 4.3: Save the Plot ---
ggsave(
  filename = file.path(output_dir, "LINE_WIDTH.jpeg"),
  plot = width_plot,
  width = 12, height = 12, units = "cm",
  dpi = 600, device = "cairo_jpeg"
)


# -----------------------------------------------------------------------------
# SECTION 5: LINE LENGTH ANALYSIS (mm)
# -----------------------------------------------------------------------------

# --- 5.1: Calculate Line Length ---
# The original calculation was `n() * 2 + 100`. This assumes the width_step
# from the Python script was 2px and adds a 100px constant.
# We will use this logic.
length_data <- full_data %>%
  group_by(filename_base, file_group, distance_10_mm_px) %>%
  # width_step was 2 in the Python script that generated the data
  summarise(length_px = n() * 2, .groups = 'drop') %>%
  mutate(length_mm = length_px / (distance_10_mm_px / 10)) %>%
  filter(str_detect(file_group, FILTER_COMPOSITION)) %>%
  group_by(file_group) %>%
  summarise(
    mean_length_mm = mean(length_mm, na.rm = TRUE),
    sd_length_mm = sd(length_mm, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(file_group = factor(file_group, levels = LOGICAL_ORDER))

# --- 5.2: Plot Line Length ---
length_plot <- ggplot(data = length_data, aes(x = file_group, y = mean_length_mm, color = file_group)) +
  geom_bar(stat = "identity", fill = NA, linewidth = 1) +
  geom_errorbar(
    aes(
      ymin = mean_length_mm - sd_length_mm,
      ymax = mean_length_mm + sd_length_mm
    ),
    width = width_index,
    linewidth = 1
  ) +
  scale_y_continuous(limits = c(0, 250), breaks = seq(0, 250, 50)) +
  scale_color_manual(values = colors) +
  labs(x = "Sample", y = "Line length (mm)") +
  bbc_style() +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.title = element_text(size = axis.title.font.size, face = "bold"),
    axis.text = element_text(size = axis.text.font.size)
  )

# --- 5.3: Save the Plot ---
ggsave(
  filename = file.path(output_dir, "LINE_LENGTH.jpeg"),
  plot = length_plot,
  width = 12, height = 12, units = "cm",
  dpi = 600, device = "cairo_jpeg"
)

print("Analysis complete. Plots saved to output directory.")
